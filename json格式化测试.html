<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>json格式化测试</title>
    <meta
      content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0"
      name="viewport"
    />
    <meta name="renderer" content="webkit" />
    <style>
      * {
        margin: 0;
        padding: 0;
        list-style: none;
      }
      body {
        font-size: 14px;
        font-family: -apple-system, PingFang SC, Hiragino Sans GB,
          Microsoft YaHei, Helvetica Neue, Arial, sans-serif;
        color: #27282b;
        background: #fff;
      }
      a {
        text-decoration: none;
        color: #27282b;
      }
      *,
      *::before,
      *::after {
        outline: none;
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      .d1 {
        width: 50%;
        height: 100px;
        background: #eee;
        user-select: none;
        margin: 0 auto 50px auto;
      }
    </style>
  </head>

  <body>
    <div class="wrapper" id="app"></div>

    <script src="https://lib.baomitu.com/vue/2.6.10/vue.min.js"></script>
    <script>
      'use strict';
      let vm = new Vue({
        el: '#app',
        data() {
          return {
            arr: [],
            formatted: '',
            objectData: {
              name: 'testData',
              type: 'dir',
              size: 727347234,
              children: [
                {
                  name: 'atestFile.py',
                  type: 'file'
                },
                {
                  name: 'atestFile2.py',
                  type: 'file'
                },
                {
                  name: 'images',
                  type: 'dir',
                  children: [
                    {
                      name: '1111.jpg',
                      type: 'file'
                    },
                    {
                      name: '12222.jpg',
                      type: 'file'
                    },
                    {
                      name: '13333.jpg',
                      type: 'file'
                    },
                    {
                      name: '14444.jpg',
                      type: 'file'
                    },
                    {
                      name: 'testFolder2222',
                      type: 'dir',
                      children: []
                    },
                    {
                      name: 'testFolder3333',
                      type: 'dir',
                      children: [
                        {
                          name: '166666.jpg',
                          type: 'file'
                        },
                        {
                          name: '1777777.jpg',
                          type: 'file'
                        }
                      ]
                    },
                    {
                      name: '166666.jpg',
                      type: 'file'
                    },
                    {
                      name: '1777777.jpg',
                      type: 'file'
                    }
                  ]
                },
                {
                  name: 'testFile.py',
                  type: 'file'
                },
                {
                  name: 'testFile2.py',
                  type: 'file'
                }
              ]
            }
          };
        },
        methods: {
          formatTree(obj) {
            this.formatted = ''
            if (typeof obj !== 'object') {
              throw new Error('param is not a object');
            }
            console.log('after throw')
            this.addLine(obj);
            return this.formatted;
          },
          addLine(
            obj,
            padNum = 0,
            PADDING = '    ',
            dirPre = ' {',
            dirLast = '}',
            newLine = '\r\n'
          ) {
            let padding = '';
            for (let i = 0; i < padNum; i++) {
              padding += PADDING;
            }
            if (obj.type === 'dir' || obj.type === 'directory') {
              // 文件夹首行
              this.formatted += padding + obj.name + dirPre + newLine;

              let j = 0;
              let last = obj.children.length - 1;
              if (!obj.children.length) {
                // 文件夹末行
                this.formatted += padding + dirLast + newLine;
              } else {
                padNum++;
                for (; j <= last; j++) {
                  let child = obj.children[j];

                  this.addLine(child, padNum);

                  // 文件夹末行
                  if (j === last) {
                    this.formatted += padding + dirLast + newLine;
                  }
                }
              }
            } else {
              this.formatted += padding + obj.name + newLine;
            }
          },
          formatJson(json, options) {
            var reg = null,
              formatted = '',
              pad = 0,
              PADDING = '    ';
            options = options || {};
            options.newlineAfterColonIfBeforeBraceOrBracket =
              options.newlineAfterColonIfBeforeBraceOrBracket === true
                ? true
                : false;
            options.spaceAfterColon =
              options.spaceAfterColon === false ? false : true;
            if (typeof json !== 'string') {
              json = JSON.stringify(json);
            } else {
              json = JSON.parse(json);
              json = JSON.stringify(json);
            }
            reg = /([\{\}])/g;
            json = json.replace(reg, '\r\n$1\r\n');
            reg = /([\[\]])/g;
            json = json.replace(reg, '\r\n$1\r\n');
            reg = /(\,)/g;
            json = json.replace(reg, '$1\r\n');
            reg = /(\r\n\r\n)/g;
            json = json.replace(reg, '\r\n');
            reg = /\r\n\,/g;
            json = json.replace(reg, ',');
            if (!options.newlineAfterColonIfBeforeBraceOrBracket) {
              reg = /\:\r\n\{/g;
              json = json.replace(reg, ':{');
              reg = /\:\r\n\[/g;
              json = json.replace(reg, ':[');
            }
            if (options.spaceAfterColon) {
              reg = /\:/g;
              json = json.replace(reg, ':');
            }
            json.split('\r\n').forEach(function(node, index) {
              var i = 0,
                indent = 0,
                padding = '';

              if (node.match(/\{$/) || node.match(/\[$/)) {
                indent = 1;
              } else if (node.match(/\}/) || node.match(/\]/)) {
                if (pad !== 0) {
                  pad -= 1;
                }
              } else {
                indent = 0;
              }

              for (i = 0; i < pad; i++) {
                padding += PADDING;
              }

              formatted += padding + node + '\r\n';
              pad += indent;
            });
            return formatted;
          }
        },
        mounted() {
          let str = this.formatTree(this.objectData);
          console.log(str);
          let str2 = this.formatJson(this.objectData);
          console.log(str2);
        }
      });
    </script>
  </body>
</html>
